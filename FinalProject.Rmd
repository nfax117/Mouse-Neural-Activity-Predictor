---
title: "STA 141A Final Project: Predictive Model of Mice Neural Activity"
author: "Nathaniel Faxon"
date: "2023-04-18"
output: html_document
abstract: |
  Put the abstract here
---

1st Task: Understanding Data

1)  Abstract -\> What you did in the project (3-4 sentences)

## Introduction

2)  Introduction

-   Questions of interest along with real-world motivation

    -   In the original study, the neural activity of 30,000 neurons in 42 brain regions of mice were analyzed. There were 10 mice analyzed over 39 different sessions. Within each session, visual stimuli were presented to the mice at random, then the reaction of the mice to this stimuli were recorded.
    -   In this project, we will be analyzing the different trials and recorded neuron spikes in order to make a predictive model.

-   Impact of results

-   Basic information of data (source, key variables, hypotheses), method, and why.

    -   The data comes from 18 different session of 4 different mice brain neural activity. The four mice that we are studying the neural responses of are Cori, Forssmann, Hench, and Lederberg. More specifically, the first three sessions analyzed Cori, the next four Forssmann, the next four Hench, and the last seven Lederberg. These sessions were taken between 12/14/2016 through 12/11/2017.

    -   Within each session, there were many trials where the activity of the neurons in the mice's visual cortex was recorded based on their decision making when faced with visual stimuli. Their decision making consists of turning the wheel either to the left or right or holding it still. Different variables were recorded for the 4 different mice. 8 variables are recorded each session:

        -   brain_area: The area of the brain where each neuron lives.
        -   contrast_left: Contrast on the left stimulus. Can take values 0, 0.25, 0.5, 1 (0 indicating the absence of a stimulus).
        -   contrast_right: Contrast on the right stimulus. Can take values 0, 0.25, 0.5, 1 (0 indicating the absence of a stimulus).
        -   date_exp: Date of the experiment on the mouse.
        -   feedback_type: The type of feedback that was administered base on the outcome of the mouse's decision. There are four different cases that can happen:
            -   When the right contrast is greater than the left contrast: If the mouse turned the wheel to the left, feedback_type = 1. If turned to the right, feedback_type = -1.
            -   When the left contrast is greater than the right contrast: If the mouse turned the wheel to the right, feedback_type = 1. If turned to the left, feedback_type = -1.
            -   When the left contrast and right contrast equal 0: If mouse held the wheel still, feedback_type = 1. Otherwise, feedback_type = -1.
            -   When the left contrast and right contrast are equal and not both 0: There is a 50% chance that feedback_type = 1 or -1.
        -   mouse_name: Name of the mouse being used in the experiment (trial). Specific to this project, the 4 mice are Cori, Forssmann, Hench, and Lederberg.
        -   spks: Numbers of spikes of neurons in the visual cortex. Holds many different trials.
        -   time: Center of the time bins for the spks.

-   Existing research and known results

## Exploratory Analysis

3)  Exploratory Analysis

-   Basic descriptive statistics (missing, mean, quartiles, \# of observations)
-   Data visualization (features, patterns in data)

## Methodology

4)  Methodology:

-   Data Integration: PCA, clustering (improving prediction performance)
-   Predictive Model (GLM, linear regression, time series)

### Data Integration

### Predictive Modeling

5)  Result (prediction performance)

6)  Conclusion, Discussion

-   Findings, variable information, drawbacks/disadvantages, next steps

7)  References


```{r}
suppressWarnings(library(tidyverse))
suppressWarnings(library(ggplot2))
suppressWarnings(library(knitr))
suppressWarnings(library(dplyr))
suppressWarnings(library(gtools))
suppressWarnings(library(corrplot))
suppressWarnings(library(gridExtra))
suppressWarnings(library(PerformanceAnalytics))
suppressWarnings(library(grDevices))
suppressWarnings(library(viridis))
suppressWarnings(library(RColorBrewer))
```

```{r}

session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste('./Data/session',i,'.rds',sep=''))
  #print(session[[i]]$mouse_name)
  #print(session[[i]]$date_exp)
  
}

```

## Understanding the DataSet

# Information of each session

```{r}

# Get the variables recorded within this session
print(ls(session[[1]])) # or names(session[[1]]))

#Determine the different variables and details within each session

uniqueBrainareasVector <- c()

for (i in 1:18) {
  
  message("Session ", i)
  
  session_i <- session[[i]]
  
  print(session[[i]]$mouse_name)
  print(session[[i]]$date_exp)
  
  # Get the affected brain areas within this session
  print("Affected brain areas:")
  print(unique(session_i$brain_area))
  
  uniqueBrainareasVector <- append(uniqueBrainareasVector, unique(session_i$brain_area))
  
  # Get the number of trials within the session
  print("Number of trials:")
  print(length(session_i$feedback_type))
  
}

# Get the unique brainareas through all sessions
uniqueBrainareasVector <- unique(uniqueBrainareasVector)
uniqueBrainareasVectorLength = length(uniqueBrainareasVector)
message("There are ", uniqueBrainareasVectorLength, " unique brain areas throughout all sessions:")
print(uniqueBrainareasVector)



```

# Parse Into Dataframe

```{r}

#See which brain area is responsible for feedback

#Create boxplot (can be other plots) of one brain area, the firing rate (or num of neurons) and feedback_type

# Have two dataframes, one for average spks across trials, another for average spikes per brain area for each session

# Maybe try to find how brain area firing rates differ between mice

```

```{r}
# Dataframe for the average spks per trial for each session

# Function to calculate the average spks per brain area for the specific trial of a session
firing_rate_brainarea <- function(trialNum, currSession) {
  
  spkTrial = currSession$spks[[trialNum]]
  currBrainArea = currSession$brain_area
  spkCount = apply(spkTrial, 1, sum)
  spkAvg = tapply(spkCount, currBrainArea, mean)
  return(spkAvg)
  
}


# Function to find average spks per brain area for all trials in a session
trial_firing_rate_brainarea <- function(sessionNum) {
  
  trialLen = length(session[[sessionNum]]$feedback_type)
  brainareaLen = length(unique(session[[sessionNum]]$brain_area))
  
  trialBrainareaSummary = matrix(nrow = trialLen, ncol = brainareaLen + 2)
  
  for(q in 1:trialLen) {
    
    trialBrainareaSummary[q,] = c(firing_rate_brainarea(q, currSession = session[[sessionNum]]), sessionNum, q)
    
  }
  
  colnames(trialBrainareaSummary) = c(names(firing_rate_brainarea(q,currSession = session[[sessionNum]])), 'session_number', 'trial_number')
  
  trialBrainareaSummary <- as_tibble(trialBrainareaSummary)
  
  
  # Plot the spikes per area in each session against trials
  colorPalette = brewer.pal(n=brainareaLen, name = 'Paired')

  plot(0~1, col='white',xlim=c(0,trialLen),ylim=c(0.5,2.2), xlab="Trials",ylab="Average Spike Counts", main=paste("Spikes per Area in Session", sessionNum))
  
  for(i in 1:brainareaLen){
    lines(y=trialBrainareaSummary[[i]],x=trialBrainareaSummary$trial_number,col=colorPalette[i],lty=2,lwd=1)
    lines(smooth.spline(trialBrainareaSummary$trial_number, trialBrainareaSummary[[i]]),col=colorPalette[i],lwd=3)
  }
  
  legend("topright", 
         legend = colnames(trialBrainareaSummary)[1:brainareaLen], 
         col = colorPalette, 
         lty = 1, 
         cex = 0.8
  )
    
    
    # Plot the correlation matrix for the brain areas, see if there are relations between brain areas
    correlationMatrixPlot <- suppressWarnings(chart.Correlation(trialBrainareaSummary[, 3:brainareaLen], histogram = TRUE, pch = 7, alpha = 0.3))
    correlationMatrixPlot
    
  
  # Return the dataframe of brain areas for one session
  return(trialBrainareaSummary)
  
}

# TODO: Try to make plots side by side for each session

# Use above function to apply to all sessions, bind them together to make one dataframe of all session brainarea spk averages. 

brainarea_firing_rateDF <- data.frame()

for (p in 1:18) {
  
  brainarea_firing_rateDF = bind_rows(brainarea_firing_rateDF, trial_firing_rate_brainarea(p))

}

head(brainarea_firing_rateDF)




# In the correlation matrices:
#The distribution of each variable is shown on the diagonal.
#On the bottom of the diagonal : the bivariate scatter plots with a fitted line are displayed
#On the top of the diagonal : the value of the correlation plus the significance level as stars
#Each significance level is associated to a symbol : p-values(0, 0.001, 0.01, 0.05, 0.1, 1) <=> symbols(“***”, “**”, “*”, “.”, " “)

```

```{r}
# Dataframe with general statistics across sessions

sessionDF <- data.frame()

for (i in 1:18) {

  #Create a custom dataframe here with 4 columns for 4 variables
  trialDF <- data.frame(matrix(ncol = 4, nrow = 0))

  for (j in 1:length(session[[i]]$spks)) { 
    
    # Calculate the total number of neurons active
    neuronCountTable = table(unlist(session[[i]]$spks[[j]]))
    neuronCountValues = as.numeric(neuronCountTable)
    numActiveNeurons = length(session[[i]]$spks[[j]]) - neuronCountValues[1] #neuronCountValues[1] is the # of 0's
    
    # Calculate the total number of spks
    numSpks = 0
    for(k in 1:length(neuronCountTable)) {
    
      numSpks = numSpks + ((k-1) * neuronCountValues[k])
      
    }
    
    # Calculate the proportion of active neurons
    activeNeuronProp = numActiveNeurons / length(session[[i]]$spks[[i]])
    
    # Calculate the firing rate (total number of spks != 0 divided by total)
    firing_rate = numSpks / (numSpks + neuronCountValues[1])
    
    
    # Append to the variables to the trial data frame
    trialDF[nrow(trialDF) + 1,] = c(numActiveNeurons, numSpks, activeNeuronProp, firing_rate)
    
  }
  

  # Append data together using cbind
  tempSession = cbind(rep(i,length(session[[i]]$contrast_left)),
                       seq(1, length(session[[i]]$spks)),
                       session[[i]]$mouse_name, 
                       session[[i]]$contrast_left,
                       session[[i]]$contrast_right,
                       length(session[[i]]$brain_area),
                       length(unique(session[[i]]$brain_area)),
                       length(session[[i]]$spks),
                       trialDF,
                       session[[i]]$feedback_type
                       )
  
  # Append each session using rbind
  if (i == 1){
    sessionDF <- tempSession
  }
  else {
    sessionDF = rbind(sessionDF, tempSession)
  }
  
  
}


colnames(sessionDF) = c("session_number", "trial_number", "mouse_name", "contrast_left", "contrast_right", "total_number_of_neurons", "number_of_unique_brain_area", "number_of_trials", "number_of_active_neurons", "total_number_of_spks", "proportion_of_active_neurons", "firing_rate", "feedback_type")
sessionDF = as.data.frame(sessionDF)
sessionDF$trial_number = as.factor(sessionDF$trial_number)
#sessionDF$contrast_left = as.factor(sessionDF$contrast_left)
#sessionDF$contrast_right = as.factor(sessionDF$contrast_right)
#sessionDF$feedback_type = as.factor(sessionDF$feedback_type)
head(sessionDF)

```

# Plots

```{r}

# Box plots of firing rate (or numberofactiveneurons, total num of spikes, or proportion) on feedbacktype
# Mention how spks and active neurons are different, since there can be multiple spks per neuron


# Box Plots

# Firing Rate on Feedback Type
firingRate_by_feedback_boxPlot <- ggplot(sessionDF, aes(x = feedback_type, y = firing_rate, col = feedback_type)) + geom_boxplot(outlier.colour="red", outlier.shape=8, outlier.size=2, alpha = 0.2) + xlab("Feedback Type") + ylab("Firing Rate") + ggtitle("Box Plot of Firing Rate on Feedback Type") + theme(legend.position="none")

# Number of Active Neurons on Feedback Type
numActiveNeurons_by_feedback_boxPlot <- ggplot(sessionDF, aes(x = feedback_type, y = number_of_active_neurons, col = feedback_type)) + geom_boxplot(outlier.colour="red", outlier.shape=8, outlier.size=2, alpha = 0.2) + xlab("Feedback Type") + ylab("Number of Active Neurons") + ggtitle("Box Plot of Number of Active Neurons on Feedback Type") + theme(legend.position="none")

# Total Number of Spikes on Feedback Type
totalNumSpikes_by_feedback_boxPlot <- ggplot(sessionDF, aes(x = feedback_type, y = total_number_of_spks, col = feedback_type)) + geom_boxplot(outlier.colour="red", outlier.shape=8, outlier.size=2, alpha = 0.2) + xlab("Feedback Type") + ylab("Total Number of Spikes") + ggtitle("Box Plot of Total Number of Spikes on Feedback Type") + theme(legend.position="none")

# Proportion of Active Neurons on Feedback Type
proportionActiveNeurons_by_feedback_boxPlot <- ggplot(sessionDF, aes(x = feedback_type, y = proportion_of_active_neurons, col = feedback_type)) + geom_boxplot(outlier.colour="red", outlier.shape=8, outlier.size=2, alpha = 0.2) + xlab("Feedback Type") + ylab("Proportion of Active Neurons") + ggtitle("Box Plot of Proportion of Active Neurons on Feedback Type") + theme(legend.position="none")


grid.arrange(firingRate_by_feedback_boxPlot, proportionActiveNeurons_by_feedback_boxPlot, numActiveNeurons_by_feedback_boxPlot, totalNumSpikes_by_feedback_boxPlot, nrow = 2, ncol = 2)
 
```

```{r}

# Correlation Matrices for each Session
for (i in 1:18) {
  
  corrplot.mixed(round(cor(sessionDF[sessionDF$session_number == i, c('contrast_left', 'contrast_right', 'number_of_active_neurons', 'total_number_of_spks', 'proportion_of_active_neurons', 'firing_rate', 'feedback_type')]), 2), title = paste("Correlation Matrix of Session", i), mar=c(1,1,1,1))
  
}
```


```{r}

# Correlation Matrices for Each Mouse
mouseNameVector <- c('Cori', 'Forssmann', 'Hench', 'Lederberg')
for (i in 1:length(mouseNameVector)) {
  
  corrplot.mixed(round(cor(sessionDF[sessionDF$mouse_name == mouseNameVector[i], c('contrast_left', 'contrast_right', 'number_of_active_neurons', 'total_number_of_spks', 'proportion_of_active_neurons', 'firing_rate', 'feedback_type')]), 2), title = paste("Correlation Matrix of Mouse", mouseNameVector[i]), mar=c(1,1,1,1))
  
}

```

```{r}
# Plots for variables against trials

for (i in 1:18) {
 
  plot1 <- ggplot(sessionDF[sessionDF$session_number == i,], aes(x = trial_number, y = number_of_active_neurons)) + geom_point() + geom_smooth(method="lm")
  plot2 <- ggplot(sessionDF[sessionDF$session_number == i,], aes(x = trial_number, y = total_number_of_spks)) + geom_point() + geom_smooth(method="lm")
  plot3 <- ggplot(sessionDF[sessionDF$session_number == i,], aes(x = trial_number, y = proportion_of_active_neurons)) + geom_point() + geom_smooth(method="lm")
  plot4 <- ggplot(sessionDF[sessionDF$session_number == i,], aes(x = trial_number, y = firing_rate)) + geom_point() + geom_smooth(method="lm")
  
  grid.arrange(plot1, plot2, plot3, plot4, nrow = 2, ncol = 2)
   
}



```


# Extra

```{r}

dat <- session[[1]]

#session[[1]]$brain_area

unique(dat$brain_area)

i_trial = 12;
i_session = 1;

dim(session[[i_session]]$spks[[i_trial]])

length(session[[i_session]]$feedback_type)

apply(session[[i_session]]$spks[[i_trial]], 2, sum)

names(session[[2]])

#Use different spks trials to make predictive models (logistic regression will work, show some linear or svm)
#session[[i_session]]$spks[[i_trial]]
#to predict:
#session[[i_session]]$feedback_type[i_trial]

# LOOK AT COURSE PROJECT DESCRIPTION .RMD FOR VARIABLE EXPLORATION

#Ask if we are using the trials of spks in combination with other recorded variables (eg. brain_area, contrast_left, contrast_right) to predict the feedback_type. Yes

#Predict the feedback_type per trial, not session

# Create df including all sessions, each session df will have rows as trials, and the columns will be variables of each trial (contrast_left, contrast_right, firing_rate, feedback_type). Use bind to stack each session df.

```

```{r}

session[[5]]$spks[[11]]
session[[5]]$contrast_left[11]
session[[5]]$contrast_right[11]
session[[5]]$feedback_type[11]

length(session[[5]]$spks[[1]])
table(unlist(session[[5]]$spks[1]))

length(session[[5]]$spks)

#Why is this different
#length(session[[1]]$spks[[1]])
#length(session[[1]]$spks[1])
#if this results in same
#session[[1]]$spks[[1]]
#session[[1]]$spks[1]

```
